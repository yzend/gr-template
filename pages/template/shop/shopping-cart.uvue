<template>
	<cl-page>
		<cl-sticky>
			<cl-topbar fixed safe-area-top :title="`${$t('è´­ç‰©è½¦ ({num})', { num: list.length })}`">
				<template #prepend>
					<!-- #ifdef MP -->
					<cl-text
						:pt="{
							className: 'ml-1'
						}"
						@tap="isDel = !isDel"
					>
						{{ isDel ? t("å®Œæˆ") : t("ç®¡ç†") }}
					</cl-text>
					<!-- #endif -->
				</template>

				<template #append>
					<!-- #ifndef MP -->
					<cl-text
						:pt="{
							className: 'mr-3'
						}"
						@tap="isDel = !isDel"
					>
						{{ isDel ? t("å®Œæˆ") : t("ç®¡ç†") }}
					</cl-text>
					<!-- #endif -->
				</template>
			</cl-topbar>
		</cl-sticky>

		<view class="p-3">
			<view class="p-3 rounded-xl bg-white dark:!bg-surface-800 mb-3">
				<cl-text
					:pt="{
						className: 'text-sm'
					}"
					>ğŸ”¥ æœ€æ–°é™ä»·å•†å“ï¼Œé™æ—¶ä¼˜æƒ ï¼ŒæŠ“ç´§æŠ¢è´­ï¼</cl-text
				>
			</view>

			<cl-list-item
				v-for="(item, index) in list"
				:key="item.id"
				:pt="{
					className: parseClass([
						'rounded-2xl ',
						[index == list.length - 1, 'mb-0', 'mb-3']
					]),
					inner: {
						className: '!p-4'
					}
				}"
				swipeable
			>
				<view class="flex flex-row flex-1">
					<view class="flex flex-col mr-4 pt-[55rpx]" @tap="selectItem(item)">
						<cl-icon
							name="checkbox-circle-line"
							color="primary"
							:size="40"
							v-if="item.checked"
						></cl-icon>
						<cl-icon name="checkbox-blank-circle-line" :size="40" v-else></cl-icon>
					</view>

					<cl-image :width="150" :height="150" :src="item.cover"></cl-image>

					<view class="flex flex-col ml-3 flex-1">
						<cl-text
							:pt="{
								className: 'mb-2 font-bold'
							}"
							>{{ item.name }}</cl-text
						>

						<view class="flex flex-row mb-2">
							<view
								class="bg-surface-100 dark:!bg-surface-700 rounded-md py-1 px-2 flex flex-row items-center"
							>
								<cl-text
									:pt="{
										className: 'text-xs'
									}"
									>{{ item.skuName }}</cl-text
								>
								<cl-icon name="arrow-down-s-line"></cl-icon>
							</view>
						</view>

						<view class="flex flex-row items-center mb-2">
							<cl-text
								:pt="{
									className: 'text-[22rpx] text-red-500 mr-[1rpx]'
								}"
								>Â¥</cl-text
							>
							<cl-text
								:pt="{
									className: 'text-red-500 text-[32rpx] mr-auto'
								}"
								>{{ item.price }}</cl-text
							>

							<view
								v-if="isDel"
								class="p-[8rpx] bg-red-500 rounded-lg"
								@tap="delItem(index)"
							>
								<cl-icon name="delete-bin-line" color="white" :size="24"></cl-icon>
							</view>

							<view class="flex" v-else>
								<cl-input-number
									v-model="item.count"
									:size="40"
									:min="1"
									:pt="{
										op: {
											plus: {
												className: '!rounded-full'
											},
											minus: {
												className: '!rounded-full'
											},
											icon: {
												size: 28
											}
										},
										value: {
											className: '!w-[60rpx] rounded-full !px-0',
											input: {
												className: 'text-[24rpx]'
											}
										}
									}"
								></cl-input-number>
							</view>
						</view>

						<cl-text :size="22" color="error">æ¯”åŠ å…¥æ—¶é™Â¥100</cl-text>

						<cl-text :size="22">æ»¡1ä»¶å¯æ¢è´­0.5å…ƒå•†å“</cl-text>
					</view>
				</view>

				<template #swipe-right>
					<cl-button
						type="error"
						:pt="{
							className: '!rounded-none h-full w-[160rpx]'
						}"
						@tap="delItem(index)"
						>{{ t("åˆ é™¤") }}</cl-button
					>
				</template>
			</cl-list-item>

			<cl-empty v-if="list.length == 0"></cl-empty>
		</view>

		<cl-footer>
			<view class="flex flex-row items-center h-[70rpx]">
				<cl-checkbox
					active-icon="checkbox-circle-line"
					inactive-icon="checkbox-blank-circle-line"
					:pt="{
						className: 'mr-auto'
					}"
					:size="28"
					v-model="selectAll"
					@change="onSelectAllChange"
					>{{ t("å…¨é€‰") }}</cl-checkbox
				>

				<template v-if="isDel">
					<cl-button
						type="error"
						:pt="{
							className: '!px-5'
						}"
						@tap="delAll"
					>
						{{ t("åˆ é™¤") }}
					</cl-button>
				</template>

				<template v-else>
					<view class="flex flex-col mr-3 items-end pt-1">
						<cl-text
							color="info"
							:pt="{
								className: 'text-xs'
							}"
							>{{ t("åˆè®¡") }}</cl-text
						>
						<cl-text color="error" :value="totalPrice" type="amount"></cl-text>
					</view>

					<cl-button
						type="error"
						:pt="{
							className: '!px-8'
						}"
						@tap="toSettle"
					>
						{{ t("å»ç»“ç®—") }}
					</cl-button>
				</template>
			</view>
		</cl-footer>
	</cl-page>
</template>

<script lang="ts" setup>
import { parseClass, isEmpty } from "@/cool";
import { $t, t } from "@/locale";
import { useUi } from "@/uni_modules/cool-ui";
import { computed, ref } from "vue";

const ui = useUi();

// å•†å“ç±»å‹
type Goods = {
	id: number;
	name: string;
	count: number;
	price: number;
	cover: string;
	skuName: string;
	checked: boolean;
};

// å•†å“åˆ—è¡¨
const list = ref<Goods[]>([
	{
		id: 1,
		name: "Apple iPad",
		count: 1,
		price: 450,
		cover: "https://img.yzcdn.cn/vant/ipad.png",
		skuName: "æ·±ç©ºç°è‰² 128GB WLANç‰ˆ",
		checked: true
	},
	{
		id: 2,
		name: "Samsung Galaxy S24",
		count: 2,
		price: 699,
		cover: "https://img.yzcdn.cn/vant/samsung.png",
		skuName: "æ›œçŸ³é»‘ 12GB+256GB å®˜æ–¹æ ‡é…",
		checked: false
	},
	{
		id: 3,
		name: "Sony WH-1000XM5",
		count: 1,
		price: 299,
		cover: "https://img.yzcdn.cn/vant/sony.png",
		skuName: "é»‘è‰² æ— çº¿è“ç‰™ å®˜æ–¹æ ‡é…",
		checked: false
	},
	{
		id: 4,
		name: "å°ç±³æ‰‹ç¯8",
		count: 3,
		price: 49,
		cover: "https://img.yzcdn.cn/vant/xiaomi.png",
		skuName: "æ›œçŸ³é»‘ æ ‡å‡†ç‰ˆ ç¡…èƒ¶è¡¨å¸¦",
		checked: false
	},
	{
		id: 5,
		name: "Kindle Paperwhite",
		count: 1,
		price: 120,
		cover: "https://img.yzcdn.cn/vant/kindle.png",
		skuName: "é»‘è‰² 8GB å®˜æ–¹æ ‡é…",
		checked: false
	}
]);

// æ˜¯å¦å…¨é€‰
const selectAll = ref(false);

/**
 * é€‰æ‹©/å–æ¶ˆé€‰æ‹©å•ä¸ªå•†å“
 * @param item éœ€è¦æ“ä½œçš„å•†å“
 */
function selectItem(item: Goods) {
	// åˆ‡æ¢é€‰ä¸­çŠ¶æ€
	item.checked = !item.checked;
	// åˆ¤æ–­æ˜¯å¦æ‰€æœ‰å•†å“éƒ½è¢«é€‰ä¸­ï¼Œæ›´æ–°å…¨é€‰çŠ¶æ€
	selectAll.value = list.value.every((item) => item.checked);
}

/**
 * å…¨é€‰/å–æ¶ˆå…¨é€‰
 * @param val æ˜¯å¦å…¨é€‰
 */
function onSelectAllChange(val: boolean) {
	list.value.forEach((item, index, arr) => {
		// item.checked = val; // è¿™æ ·å†™ï¼Œåœ¨ android ä¸Šæ— æ•ˆ
		arr[index].checked = val;
	});
}

// æ˜¯å¦å¤„äºåˆ é™¤æ¨¡å¼
const isDel = ref(false);

/**
 * åˆ é™¤å•ä¸ªå•†å“
 * @param index å•†å“ç´¢å¼•
 */
function delItem(index: number) {
	ui.showConfirm({
		title: t("æ¸©é¦¨æç¤º"),
		message: t("ç¡®å®šåˆ é™¤è¯¥å•†å“å—ï¼Ÿ"),
		callback(action) {
			if (action === "confirm") {
				// åˆ é™¤æŒ‡å®šç´¢å¼•çš„å•†å“
				list.value.splice(index, 1);

				ui.showToast({
					message: t("åˆ é™¤æˆåŠŸ")
				});
			}
		}
	});
}

/**
 * åˆ é™¤æ‰€æœ‰å·²é€‰ä¸­çš„å•†å“
 */
function delAll() {
	const checked = list.value.filter((item) => item.checked);

	// å¦‚æœæ²¡æœ‰é€‰ä¸­å•†å“ï¼Œæç¤ºç”¨æˆ·
	if (isEmpty(checked)) {
		return ui.showToast({
			message: t("è¯·å…ˆé€‰æ‹©å•†å“")
		});
	}

	ui.showConfirm({
		title: t("æ¸©é¦¨æç¤º"),
		message: t("ç¡®å®šåˆ é™¤é€‰ä¸­çš„å•†å“å—ï¼Ÿ"),
		callback(action) {
			if (action == "confirm") {
				// åªä¿ç•™æœªé€‰ä¸­çš„å•†å“
				list.value = list.value.filter((item) => !item.checked);

				// å¦‚æœä¹‹å‰æ˜¯å…¨é€‰ï¼Œåˆ é™¤åå–æ¶ˆå…¨é€‰çŠ¶æ€
				if (selectAll.value) {
					selectAll.value = false;
				}

				ui.showToast({
					message: t("åˆ é™¤æˆåŠŸ")
				});
			}
		}
	});
}

/**
 * æ¸…ç©ºè´­ç‰©è½¦
 */
function clear() {
	list.value = [];
	selectAll.value = false;
	isDel.value = false;
}

/**
 * è®¡ç®—å·²é€‰ä¸­å•†å“çš„æ€»ä»·
 */
const totalPrice = computed(() => {
	return list.value
		.filter((item) => item.checked)
		.reduce((acc, item) => acc + item.price * item.count, 0);
});

/**
 * ç»“ç®—æ“ä½œ
 */
function toSettle() {
	// å¦‚æœæ²¡æœ‰é€‰ä¸­å•†å“ï¼Œæç¤ºç”¨æˆ·
	if (totalPrice.value <= 0) {
		return ui.showToast({
			message: t("è¯·å…ˆé€‰æ‹©å•†å“")
		});
	}

	ui.showConfirm({
		title: t("æ¸©é¦¨æç¤º"),
		message: $t("æ‚¨éœ€æ”¯ä»˜ {price} å…ƒï¼Œè¯·ç¡®è®¤æ”¯ä»˜", { price: totalPrice.value }),
		beforeClose(action, { showLoading, close }) {
			if (action == "confirm") {
				showLoading();

				setTimeout(() => {
					ui.showToast({
						message: t("æ”¯ä»˜æˆåŠŸ")
					});

					close();
				}, 1000);
			} else {
				close();
			}
		}
	});
}
</script>
